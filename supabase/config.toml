# =============================================================================
# SUPABASE LOCAL DEVELOPMENT CONFIGURATION
# Claude Builder Club @ MSU - Member Portal
# =============================================================================

# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config

# Project identifier - distinguishes different Supabase projects on the same host
project_id = "members-portal"

# =============================================================================
# API CONFIGURATION
# =============================================================================
[api]
enabled = true
# Port to use for the API URL
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API endpoints
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure
max_rows = 1000

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
[db]
# Port to use for the local database URL
port = 54322
# Port used by db diff command to initialize the shadow database
shadow_port = 54320
# The database major version to use (must match your remote database version)
major_version = 17

[db.pooler]
enabled = false
port = 54329
pool_mode = "transaction"
default_pool_size = 20
max_client_conn = 100

[db.migrations]
# If disabled, migrations will be skipped during a db push or reset
enabled = true
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset
enabled = true
sql_paths = ["./seed.sql"]

[db.network_restrictions]
enabled = false
# List of IPv4 CIDR blocks allowed to connect to the database
allowed_cidrs = ["0.0.0.0/0"]
# List of IPv6 CIDR blocks allowed to connect to the database
allowed_cidrs_v6 = ["::/0"]

# =============================================================================
# AUTHENTICATION CONFIGURATION
# =============================================================================
[auth]
enabled = true

# IMPORTANT: Update these URLs for production!
# The base URL of your website - used as an allow-list for redirects and in emails
site_url = "http://127.0.0.1:3000"

# A list of *exact* URLs that auth providers are permitted to redirect to post authentication
# Add your production URLs here: ["https://cbcmsu.dev", "https://www.cbcmsu.dev"]
additional_redirect_urls = ["https://127.0.0.1:3000"]

# Token and session settings
jwt_expiry = 3600  # 1 hour (in seconds)
enable_refresh_token_rotation = true
refresh_token_reuse_interval = 10  # seconds

# User signup settings
enable_signup = true
enable_anonymous_sign_ins = false
enable_manual_linking = false

# Password requirements
minimum_password_length = 6  # Minimum 6, recommended 8 or more
password_requirements = ""  # Options: "letters_digits", "lower_upper_letters_digits", "lower_upper_letters_digits_symbols"

# =============================================================================
# RATE LIMITING
# =============================================================================
[auth.rate_limit]
# Number of emails per hour (local development - captured by Inbucket)
email_sent = 10  # Reasonable for local testing
# Number of sessions that can be refreshed in a 5 minute interval per IP address
token_refresh = 150
# Number of sign up and sign-in requests in a 5 minute interval per IP address
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications in a 5 minute interval per IP address
token_verifications = 30

# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================
[auth.email]
# Allow new user signups via email
enable_signup = true

# Email change confirmation settings
# If true, user must confirm on BOTH old and new email addresses
# If false, only new email needs confirmation
double_confirm_changes = true

# Require email confirmation before signing in
# Set to true to require users to verify their email before they can sign in
enable_confirmations = true

# Require reauthentication for password changes
secure_password_change = false

# Minimum time between sending signup confirmation or password reset emails
max_frequency = "1s"

# OTP (One-Time Password) settings
otp_length = 6  # Number of characters in the email OTP
otp_expiry = 3600  # OTP expiration time in seconds (1 hour)

# -----------------------------------------------------------------------------
# SMTP CONFIGURATION
# -----------------------------------------------------------------------------
# NOTE: SMTP is disabled for local development
# All emails are captured by Inbucket at http://localhost:54324
# Configure SMTP in production via Supabase Dashboard → Authentication → Email
# [auth.email.smtp]
# enabled = false

# -----------------------------------------------------------------------------
# CUSTOM EMAIL TEMPLATES
# -----------------------------------------------------------------------------
# Sign-up confirmation email
[auth.email.template.confirmation]
subject = "Confirm Your Email - Claude Builder Club"
content_path = "./supabase/emails/sign-up.html"

# Password reset email
[auth.email.template.recovery]
subject = "Reset Your Password - Claude Builder Club"
content_path = "./supabase/emails/reset-password.html"

# Magic link email
[auth.email.template.otp]
subject = "Your OTP - Claude Builder Club"
content_path = "./supabase/emails/magic-link.html"


# Magic link email (passwordless sign-in)
# [auth.email.template.magic_link]
# subject = "Sign in to Claude Builder Club"
# content_path = "./supabase/emails/magic-link.html"

# Email change confirmation (sent to current email)
# [auth.email.template.email_change]
# subject = "Confirm Email Change - Claude Builder Club"
# content_path = "./supabase/emails/email-change.html"

# Invite email (for team invitations)
# [auth.email.template.invite]
# subject = "You've been invited to Claude Builder Club"
# content_path = "./supabase/emails/invite.html"

# -----------------------------------------------------------------------------
# NOTIFICATION EMAILS (informational only, not actionable)
# -----------------------------------------------------------------------------
# Uncomment to enable password change notifications
# [auth.email.notification.password_changed]
# enabled = true
# subject = "Your Claude Builder Club password has been changed"
# content_path = "./supabase/emails/notifications/password-changed.html"

# Uncomment to enable email change notifications
# [auth.email.notification.email_changed]
# enabled = true
# subject = "Your Claude Builder Club email has been changed"
# content_path = "./supabase/emails/notifications/email-changed.html"

# =============================================================================
# EXTERNAL AUTH PROVIDERS (currently disabled)
# =============================================================================
# Uncomment and configure if you want to add GitHub, Google, etc.
# [auth.external.github]
# enabled = true
# client_id = "your-github-client-id"
# secret = "env(GITHUB_CLIENT_SECRET)"

# =============================================================================
# REALTIME CONFIGURATION
# =============================================================================
[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6
# ip_version = "IPv6"

# =============================================================================
# SUPABASE STUDIO
# =============================================================================
[studio]
enabled = true
port = 54323
api_url = "http://127.0.0.1"
# OpenAI API Key for Supabase AI features in Studio
openai_api_key = "env(OPENAI_API_KEY)"

# =============================================================================
# EMAIL TESTING (INBUCKET)
# =============================================================================
# Local email testing server - view emails at http://localhost:54324
# Emails are NOT actually sent in local development
[inbucket]
enabled = true
port = 54324
# Uncomment to expose additional ports for testing
# smtp_port = 54325
# pop3_port = 54326

# =============================================================================
# STORAGE CONFIGURATION
# =============================================================================
[storage]
enabled = true
# Maximum file size allowed (e.g. "5MB", "500KB")
file_size_limit = "50MiB"

# Configure local storage buckets
# [storage.buckets.resumes]
# public = false
# file_size_limit = "10MiB"
# allowed_mime_types = ["application/pdf"]

# Allow connections via S3 compatible clients
[storage.s3_protocol]
enabled = true

# =============================================================================
# ANALYTICS
# =============================================================================
[analytics]
enabled = true
port = 54327
backend = "postgres"

# =============================================================================
# EDGE RUNTIME (for Edge Functions)
# =============================================================================
[edge_runtime]
enabled = true
# Request policy: "per_worker" enables hot reload, "oneshot" is fallback
policy = "per_worker"
inspector_port = 8083
deno_version = 2

# =====================================================================
# Edge Function: process-application-update
# ---------------------------------------------------------------------
# Disables JWT verification for this function at the gateway level. The
# function itself is responsible for authentication and authorization.
[functions.process-application-update]
verify_jwt = false

# =====================================================================
# Edge Function: process-start-automation
# ---------------------------------------------------------------------
# Disables JWT verification for this automation-triggering function at
# the gateway level. Internal logic must handle authentication.
[functions.process-start-automation]
verify_jwt = false


# =============================================================================
# NOTES FOR PRODUCTION DEPLOYMENT
# =============================================================================
# This config.toml is for LOCAL DEVELOPMENT ONLY
# Production auth settings MUST be configured via Supabase Dashboard
#
# Via CLI (code-managed):
# - supabase link --project-ref your-project-ref
# - supabase db push (migrations, RLS policies, functions)
# - supabase functions deploy (edge functions)
#
# Via Dashboard (one-time setup):
# - Authentication → Email → SMTP Settings (Resend configuration)
# - Authentication → Email Templates (upload sign-up.html, reset-password.html)
# - Authentication → Rate Limits (increase email_sent limit to 100+)
# - Authentication → URL Configuration (site_url, redirect_urls)
#
# Remember:
# - Upload email templates from supabase/emails/ to dashboard
# - Set RESEND_API_KEY in production environment variables
# - Test email flows after deployment